<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Dreamer&#39;s Land</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Dreamer&#39;s Land">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Dreamer&#39;s Land">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Y.Z. Daneel">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Dreamer's Land" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dreamer&#39;s Land</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-classifier_free_guidance" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/11/20/classifier_free_guidance/" class="article-date">
  <time class="dt-published" datetime="2024-11-20T16:39:45.720Z" itemprop="datePublished">2024-11-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/11/20/classifier_free_guidance/">Classifier Free Guidance for Diffusion models</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Classifier-Guidance"><a href="#Classifier-Guidance" class="headerlink" title="Classifier Guidance"></a>Classifier Guidance</h3><p>Diffusion models predict score functions $\nabla_x \log{p(x)}$. If the input contains conditional information such as class label, text, or image embeddings, the new score function is $\nabla_x \log{p(x|y)}$. By Bayes rule, the new score function can be written as<br>$$\nabla_x \log{p(x|y)} &#x3D; \nabla_x \log{p(y|x)} + \nabla_x \log{p(x)}.$$</p>
<p>From here we notice that $\nabla_x \log{p(y|x)}$ is exactly the log gradient of a discriminative model, or we can call it a classifier. Given a unconditional diffusion model that predicts $\nabla_x \log{p(x)}$, and a classifier that allows us to compute $\nabla_x \log{p(y|x)}$, we have the formulation for <strong>Classifier Guidance</strong>:<br>$$ \nabla_x \log{p(x|y)} &#x3D; \nabla_x \log{p(x)} + \gamma\nabla_x \log{p(y|x)}, $$<br>where $\gamma$ is the guidance scale.</p>
<p>However, it is expensive to train another classifier. Can we guide our diffusion model without additional training?</p>
<h3 id="Classifier-Free-Guidance"><a href="#Classifier-Free-Guidance" class="headerlink" title="Classifier Free Guidance"></a>Classifier Free Guidance</h3><p>Noticing that we have<br>$$<br>\begin{align}<br>\nabla_x \log{p(x|y)} &#x3D; &amp; \nabla_x \log{p(y|x)} + \nabla_x \log{p(x)}, \<br>\nabla_x \log{p(y|x)} &#x3D; &amp; b\nabla_x \log{p(x|y)} - \nabla_x \log{p(x)}.<br>\end{align}<br>$$<br>Plug this back into the formula of <strong>Classifier Guidance</strong>:<br>$$<br>\begin{align}<br>\nabla_x \log{p(x|y)} &#x3D; &amp;\nabla_x \log{p(x)} + \gamma\nabla_x \log{p(y|x)}, \<br>&#x3D; &amp; \nabla_x \log{p(x)} + \gamma(\nabla_x \log{p(x|y)} - \nabla_x \log{p(x)}), \<br>&#x3D; &amp; (1-\gamma)\nabla_x \log{p(x)} + \gamma\nabla_x \log{p(x|y)}.<br>\end{align}<br>$$</p>
<p>Normally, we train a conditioned diffusion model with an additional Null class embedding, which corresponds to the unconditional diffusion case. Thus, we only need to train the model once with true class embeddings randomly replaced by this Null class embedding. During testing, we can perform denoising with both $\nabla_x \log{p(x|\emptyset)}$ and $\nabla_x \log{p(x|y)}$. An example code of this is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">with torch.no_grad():</span><br><span class="line">    noise_pred = unet(images, timestep, condition).sample</span><br><span class="line"># Classifier-Free Guidance</span><br><span class="line">noise_pred_uncond, noise_pred_cond = noise_pred.chunk(2)</span><br><span class="line">noise_pred = (1.0 - guidance_scale) * noise_pred_uncond + guidance_scale * noise_pred_cond</span><br><span class="line">images = scheduler.step(noise_pred, timestep, images).prev_sample</span><br></pre></td></tr></table></figure>

<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a target="_blank" rel="noopener" href="https://littlenyima.github.io/posts/19-classifier-free-guidance-for-diffusion-models/index.html">https://littlenyima.github.io/posts/19-classifier-free-guidance-for-diffusion-models/index.html</a></li>
<li><a target="_blank" rel="noopener" href="https://sander.ai/2022/05/26/guidance.html">https://sander.ai/2022/05/26/guidance.html</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/11/20/classifier_free_guidance/" data-id="cm3s2vqjb00006cjda42zf1pt" data-title="Classifier Free Guidance for Diffusion models" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/11/20/classifier_free_guidance/">Classifier Free Guidance for Diffusion models</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 Y.Z. Daneel<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>